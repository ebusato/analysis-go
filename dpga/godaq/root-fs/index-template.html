<html>
	<head>
		<title>DPGA monitoring</title>
	
		<script src="static/jquery-2.2.2.min.js"></script>
		<script src="static/jquery.flot-0.8.3.min.js"></script>
		<script type="text/javascript">
		
		var sock = null;
		
		function options(bkgcolor) {
			this.series = {stack: true};
			//this.yaxis = {min: 0, max: 4096};
			this.xaxis = {tickDecimals: 0};
			this.grid = {backgroundColor: bkgcolor}
		}
		
		function plot(label, data, color) {
			this.label = label;
			this.data = data;
			this.color = color;
		}
		
		var freqplot = new plot("frequency (Hz)", [], 'orange')
		
		var multplot = new plot("Pulse multiplicity", [], 'orange')
		multplot.bars = { show: true }
		
		var colors = ['red', '#01DF01', 'blue', '#FA58F4']
		
		var Nquartets = 60
		var quartetplots = []
		var Nplots = 4
			
		for (var iq = 0; iq < Nquartets; iq += 1) {
			var pulseplots = []
			for (var ip = 0; ip < Nplots; ip += 1) {
				//pulseplots.push(new plot("q"+iq+"c"+ip, [], colors[ip]))
				pulseplots.push(new plot("", [], colors[ip]))
			}
			quartetplots.push(pulseplots)
		}
		
		function clearplots() {
			multplot.data = []
			for (var iq = 0; iq < Nquartets; iq += 1) {
				for (var ip = 0; ip < Nplots; ip += 1) {
					quartetplots[iq][ip].data = []
				}
			}
		}
		
		function update() {
			var freq = $.plot("#my-freq-plot", [freqplot]);
			freq.setupGrid(); // needed as x-axis changes
			freq.draw();
			multopts = new options()
			multopts.xaxis = {ticks: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]}
			var mult = $.plot("#my-mult-plot", [multplot], multopts);
			mult.setupGrid(); 
			mult.draw();
			for (var i = 0; i < Nquartets; i++) {
				if (i < Nquartets/2) {
					var p = $.plot("#my-q"+i+"-plot", quartetplots[i], new options('#FFFF00')); // yellow
					p.setupGrid();
					p.draw();
				}
				else {
					var p = $.plot("#my-q"+i+"-plot", quartetplots[i], new options('#ADD8E6')); // blue
					p.setupGrid();
					p.draw();
				}	
			}
		};

		window.onload = function() {
			sock = new WebSocket("ws://{{.WebAd}}/data");
			sock.onmessage = function(event) {
				var data = JSON.parse(event.data);
				console.log("data: "+JSON.stringify(data));
				if (data.freq != 0) {
					freqplot.data.push([data.time, data.freq])
				}
				for (var i = 0; i < 8; i += 1) {
					multplot.data.push([data.mult[i].X, data.mult[i].Y])
				}
				for (var iq = 0; iq < Nquartets; iq += 1) {
					for (var ip = 0; ip < Nplots; ip += 1) {
						for (var is = 0; is < 999; is += 5) {
							quartetplots[iq][ip].data.push([data.quartets[iq][ip][is].X, data.quartets[iq][ip][is].Y]);
						}
					}
				}
				update();
				clearplots();
			};
		};
		
		</script>

		<style>
		.my-plot-stylefreq {
			width: 250px;
			height: 200px;
			font-size: 14px;
			line-height: 1.2em;
		}
		.my-plot-style1 {
			width: 250px;
			height: 75px;
			font-size: 14px;
			line-height: 1.2em;
		}
		.my-plot-style {
			width: 180px;
			height: 130px;
			font-size: 14px;
			line-height: 1.2em;
		}
		</style>
	</head>

	<body>
		<div id="header">
		<h2>DPGA monitoring</h2>
		</div>
		<table cellspacing="15">
		<tr> 
		<td valign="top">
		<b>Start time:</b> {{.TimeStart}} <br>
		<b>Number of ASM Cards:</b> {{.NoASMCards}}<br>
		<b>Number of samples:</b> {{.NoSamples}}<br>
		<b>Data read:</b> {{.DataToRead}}<br>
		</td>
		<td valign="top">
		<b>Trigger equation:</b> {{.TriggerEq}}<br>
		<b>Trigger delay:</b> {{.TriggerDelay}}<br>
		<b>Channels used for trigger:</b> {{.ChanUsedForTrig}}<br>
		<b>Low and high thresholds:</b> {{.LowHighThres}}<br>
		<b>Trigger signal sample shaping for high threshold:</b> {{.TrigSigShapingHighThres}} <br>
		<b>Trigger signal sample shaping for low threshold:</b> {{.TrigSigShapingLowThres}} <br>
		</td>
		<td>
		<div id="my-freq-plot" class="my-plot-stylefreq"></div>
		</td>		
		<td>
		<div id="my-mult-plot" class="my-plot-stylefreq"></div>
		</td>
		</tr>
		</table>
		<hr>
		<table>
			<tr>    
				<td colspan="5" align="center"><b>Left hemisphere</b></td> 
				<td colspan="5" align="center"><b>Right hemisphere</b></td> 
			</tr>
			<tr>
				<td><div id="my-q0-plot" class="my-plot-style"></div></td>
				<td><div id="my-q1-plot" class="my-plot-style"></div></td>
				<td><div id="my-q2-plot" class="my-plot-style"></div></td>
				<td><div id="my-q3-plot" class="my-plot-style"></div></td>
				<td><div id="my-q4-plot" class="my-plot-style"></div></td>
				<td><div id="my-q55-plot" class="my-plot-style"></div></td>
				<td><div id="my-q56-plot" class="my-plot-style"></div></td>
				<td><div id="my-q57-plot" class="my-plot-style"></div></td>
				<td><div id="my-q58-plot" class="my-plot-style"></div></td>
				<td><div id="my-q59-plot" class="my-plot-style"></div></td>
			</tr>
			<tr>
				<td><div id="my-q5-plot" class="my-plot-style"></div></td>
				<td><div id="my-q6-plot" class="my-plot-style"></div></td>
				<td><div id="my-q7-plot" class="my-plot-style"></div></td>
				<td><div id="my-q8-plot" class="my-plot-style"></div></td>
				<td><div id="my-q9-plot" class="my-plot-style"></div></td>
				<td><div id="my-q50-plot" class="my-plot-style"></div></td>
				<td><div id="my-q51-plot" class="my-plot-style"></div></td>
				<td><div id="my-q52-plot" class="my-plot-style"></div></td>
				<td><div id="my-q53-plot" class="my-plot-style"></div></td>
				<td><div id="my-q54-plot" class="my-plot-style"></div></td>
			</tr>
			<tr>
				<td><div id="my-q10-plot" class="my-plot-style"></div></td>
				<td><div id="my-q11-plot" class="my-plot-style"></div></td>
				<td><div id="my-q12-plot" class="my-plot-style"></div></td>
				<td><div id="my-q13-plot" class="my-plot-style"></div></td>
				<td><div id="my-q14-plot" class="my-plot-style"></div></td>
				<td><div id="my-q45-plot" class="my-plot-style"></div></td>
				<td><div id="my-q46-plot" class="my-plot-style"></div></td>
				<td><div id="my-q47-plot" class="my-plot-style"></div></td>
				<td><div id="my-q48-plot" class="my-plot-style"></div></td>
				<td><div id="my-q49-plot" class="my-plot-style"></div></td>
			</tr>
			<tr>
				<td><div id="my-q15-plot" class="my-plot-style"></div></td>
				<td><div id="my-q16-plot" class="my-plot-style"></div></td>
				<td><div id="my-q17-plot" class="my-plot-style"></div></td>
				<td><div id="my-q18-plot" class="my-plot-style"></div></td>
				<td><div id="my-q19-plot" class="my-plot-style"></div></td>
				<td><div id="my-q40-plot" class="my-plot-style"></div></td>
				<td><div id="my-q41-plot" class="my-plot-style"></div></td>
				<td><div id="my-q42-plot" class="my-plot-style"></div></td>
				<td><div id="my-q43-plot" class="my-plot-style"></div></td>
				<td><div id="my-q44-plot" class="my-plot-style"></div></td>
			</tr>
			<tr>
				<td><div id="my-q20-plot" class="my-plot-style"></div></td>
				<td><div id="my-q21-plot" class="my-plot-style"></div></td>
				<td><div id="my-q22-plot" class="my-plot-style"></div></td>
				<td><div id="my-q23-plot" class="my-plot-style"></div></td>
				<td><div id="my-q24-plot" class="my-plot-style"></div></td>
				<td><div id="my-q35-plot" class="my-plot-style"></div></td>
				<td><div id="my-q36-plot" class="my-plot-style"></div></td>
				<td><div id="my-q37-plot" class="my-plot-style"></div></td>
				<td><div id="my-q38-plot" class="my-plot-style"></div></td>
				<td><div id="my-q39-plot" class="my-plot-style"></div></td>
			</tr>
			<tr>
				<td><div id="my-q25-plot" class="my-plot-style"></div></td>
				<td><div id="my-q26-plot" class="my-plot-style"></div></td>
				<td><div id="my-q27-plot" class="my-plot-style"></div></td>
				<td><div id="my-q28-plot" class="my-plot-style"></div></td>
				<td><div id="my-q29-plot" class="my-plot-style"></div></td>
				<td><div id="my-q30-plot" class="my-plot-style"></div></td>
				<td><div id="my-q31-plot" class="my-plot-style"></div></td>
				<td><div id="my-q32-plot" class="my-plot-style"></div></td>
				<td><div id="my-q33-plot" class="my-plot-style"></div></td>
				<td><div id="my-q34-plot" class="my-plot-style"></div></td>
			</tr>
		</table>
	</body>
</html>